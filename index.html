<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="images/favicon.png">
    <link rel="apple-touch-icon" href="images/favicon.png">
    <title>Dharma Paripalana Samithi Estancia</title>
    <style>
        html {scroll-behavior: smooth;}
        :root { --saffron: #FF9933; --maroon: #800000; --gold: #D4AF37; }
        body { font-family: 'Garamond', serif; margin: 0; background: #fffaf0; color: #333; line-height: 1.6; }
        
        header { background: var(--maroon); color: white; text-align: center; padding: 25px; border-bottom: 5px solid var(--saffron); }
        header h1 { margin: 0; font-size: 19px; text-transform: uppercase; letter-spacing: 1px; }
        
        nav { background: var(--saffron); display: flex; justify-content: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        nav button { background: none; border: none; padding: 15px 25px; font-size: 1rem; cursor: pointer; color: var(--maroon); font-weight: bold; transition: 0.3s; }
        nav button:hover { background: rgba(128, 0, 0, 0.1); }
        nav button.active { background: var(--maroon); color: white; }

        #slideshow-box { 
            width: 100%; height: 500px; background-size: cover; background-position: center;
            transition: background-image 1.2s ease-in-out; display: flex; align-items: flex-end;
            background-color: #444;
        }
        .hero-overlay { background: rgba(0,0,0,0.6); color: white; padding: 25px; width: 100%; text-align: center; }
        .hero-overlay h2 { margin: 0; font-size: 1.8rem; color: var(--saffron); }

        .container { max-width: 1100px; margin: 30px auto; padding: 30px; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); box-sizing: border-box;}
        .tab-content { display: none; min-height: 400px; }
        .tab-content.active { display: block; animation: fadeIn 0.6s ease; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #eee; }
        th { background: var(--maroon); color: white; padding: 15px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:nth-child(even) { background: #fffcf8; }

        .trustee-grid { display: flex; flex-wrap: wrap; gap: 40px; margin-top: 20px; }
        .column { flex: 1; min-width: 300px; }
        .column h3 { color: var(--maroon); border-bottom: 2px solid var(--saffron); padding-bottom: 10px; }
        .name-card { margin-bottom: 15px; padding: 5px 0; }

        footer { background: #222; color: #bbb; text-align: center; padding: 40px 20px; font-size: 0.9rem; }
        footer strong { color: white; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { #slideshow-box { height: 300px; } nav { flex-wrap: wrap; } }
        /* Loading Spinner Styles */
.spinner {
    display: none;
    width: 18px;
    height: 18px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    margin-right: 10px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Button state when sending */
#submitBtn.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: not-allowed;
    opacity: 0.8;
}

#submitBtn.loading .spinner {
    display: inline-block;
}
.hidden-element {
    display: none !important;
}

.visible-element {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}
/* Homepage Grid Layout */
.home-grid {
    display: grid;
    grid-template-columns: 1.5fr 1fr;
    gap: 40px;
}

.sidebar-box {
    background: #fff;
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.sidebar-box h3 {
    margin-top: 0;
    font-size: 1.1rem;
    color: var(--maroon);
    border-bottom: 2px solid var(--saffron);
    padding-bottom: 8px;
}

/* Responsive: Stack on mobile */
@media (max-width: 850px) {
    .home-grid {
        grid-template-columns: 1fr;
    }
}
.media-link-btn {
    display: inline-block;
    padding: 15px 25px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: bold;
    color: white;
    transition: transform 0.2s;
    text-align: center;
}

.media-link-btn:hover {
    transform: scale(1.05);
}

.gp-btn { background-color: #4285F4; } /* Google Blue */
.gd-btn { background-color: #34A853; } /* Google Green */
.calendar-grid-layout {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.month-card {
    background: #fff;
    border: 1px solid var(--saffron);
    border-top: 5px solid var(--maroon); /* Maroon header accent */
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.month-card h4 {
    margin: 0 0 10px 0;
    color: var(--maroon);
    text-align: center;
    text-transform: uppercase;
    font-size: 0.9rem;
    letter-spacing: 1px;
}

.month-card ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.month-card li {
    padding: 5px 0;
    font-size: 0.85rem;
    border-bottom: 1px solid #f9f9f9;
}

.month-card li:last-child {
    border-bottom: none;
}
    </style>
</head>
<body>
<header>
    <div class="header-container" style="display: flex; align-items: center; justify-content: center; max-width: 1200px; margin: 0 auto;">
        <img src="images/logo.png" alt="DPS Logo" id="main-logo" style="height: 80px; width: auto; margin-right: 20px;" onerror="this.style.display='none'">
        <div class="header-text">
            <h1 style="margin: 0; font-size: 19px; text-transform: uppercase; letter-spacing: 1px;">Dharma Paripalana Samithi Estancia</h1>
            <p style="margin: 5px 0 0; color: var(--saffron); font-weight: bold;">(A Registered Charitable Trust - Regn# 187/2021)</p>
        </div>
    </div>
</header>

<nav id="navbar">
    <button onclick="switchTab('home')" class="active">HOME</button>
    <button onclick="switchTab('activities')">ACTIVITIES RECORD</button>
    <button onclick="switchTab('about')">TRUSTEES</button>
    <button onclick="switchTab('donate')">DONATIONS</button>
    <button onclick="switchTab('contact')">CONTACT US</button>
</nav>
<div id="home" class="tab-content active">
    <div id="slideshow-box">
        <div class="hero-overlay">
            <h2 id="slide-caption">Promoting Sanatana Dharma</h2>
        </div>
    </div>
    <div class="container">
        <div class="home-grid">
            <div class="about-section">
                <h2 style="color:var(--maroon); border-bottom: 2px solid var(--saffron); padding-bottom: 10px;">Our Mission</h2>
                <p style="font-size: 1.1rem; line-height: 1.8; text-align: justify;">
                    Dharma Paripalana Samithi Estancia is a <strong>religious and charitable institution founded in 2021</strong>. 
                    It is managed by trustees comprising of <strong>Estancia complex flat owners</strong> with varied experience 
                    dedicated to promoting and spreading the values of <strong>Sanathana Dharma</strong>.
                </p>
                <p>The Samithi serves as a spiritual anchor for the Estancia community, organizing regular Bhajans, Poojas, and philanthropic activities like Annadhanam.</p>
                <div style="margin-top: 25px;">
                    <button onclick="switchTab('activities')" style="background: var(--maroon); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">View Activity Calendar</button>
                </div>
            </div>  
            <div class="info-sidebar">
                <div class="sidebar-box">
                <div id="special-sidebar-section">
                    <h3 style="margin-bottom: 10px;">üìÖ Special Events</h3>
                    <ul id="upcoming-specials-list" style="list-style: none; padding: 0; margin: 0 0 20px 0;">
                    </ul>
                </div>

                <hr style="border: 0; border-top: 1px dashed var(--saffron); margin: 15px 0;">

                <div id="monthly-sidebar-section">
                    <h3 style="margin-bottom: 10px;">üïâÔ∏è Next Monthly Poojas</h3>
                    <ul id="next-monthly-list" style="list-style: none; padding: 0; margin: 0;">
                    </ul>
                </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="activities" class="tab-content">
    <div class="container">
        <div style="text-align: right; margin-bottom: 20px;">
            <a href="#sankalpam-section" style="background: var(--saffron); color: var(--maroon); padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                üìù REGISTER FOR SANKALPAM
            </a>
        </div>
        <section id="monthly-calendar-section" style="margin-top: 50px; margin-bottom: 50px;">
            <h2 style="color:var(--maroon); border-left: 5px solid var(--saffron); padding-left: 15px;">üóìÔ∏è 2026 Monthly Pooja Calendar</h2>
            <p style="margin-bottom: 20px; color: #666; font-style: italic;">Detailed monthly dates for Pradosham and Sankatahara Chaturthi.</p>
            
            <div id="calendar-grid" class="calendar-grid-layout">
                </div>
        </section>

        <h2 style="color:var(--maroon); border-left: 5px solid var(--saffron); padding-left: 15px; margin-top: 50px;">Special Events & Yearly Calendar</h2>
        <table>
            <thead>
                <tr><th>Date/Occasion</th><th>Activity Detail</th><th>Venue</th><th>Media</th></tr>
            </thead>
            <tbody id="yearly-list"></tbody>
        </table>

        <div id="sankalpam-section" style="margin-top: 40px; padding: 25px; background: #fffcf8; border: 2px solid var(--saffron); border-radius: 10px; scroll-margin-top: 80px;">
            <h3 style="color: var(--maroon); margin-top: 0; border-bottom: 1px solid var(--saffron); padding-bottom: 10px;">
            Family Sankalpam Registration
            </h3>
            <p>New members are requested to provide their family details (Gothram, Nakshatram, etc.) for our permanent records.</p>
            <div class="jotform-container" style="width: 100%; min-height: 550px;">
                <iframe
                id="JotFormIFrame-222271804667054"
                title="Sankalpam"
                onload="window.parent.scrollTo(0,0)"
                allowtransparency="true"
                allow="geolocation; microphone; camera; fullscreen; payment"
                src="https://form.jotform.com/222271804667054"
                frameborder="0"
                style="min-width:100%;max-width:100%;height:539px;border:none;"
                scrolling="no">
                </iframe>
                <script src='https://cdn.jotfor.ms/s/umd/latest/for-form-embed-handler.js'></script>
                <script>window.jotformEmbedHandler("iframe[id='JotFormIFrame-222271804667054']", "https://form.jotform.com/")</script>
            </div>
    
            <div style="text-align: right; margin-top: 10px;">
                <a href="#navbar" style="font-size: 0.8rem; color: var(--maroon); text-decoration: none;">‚Üë Back to Top</a>
            </div>
        </div>
    </div>
</div>

<div id="about" class="tab-content">
    <div class="container">
        <div class="trustee-grid">
            <div class="column">
                <h3>Office Bearers</h3>
                <div id="mgmt-list"></div>
            </div>
            <div class="column">
                <h3>Board of Trustees</h3>
                <div id="trustee-list" style="display:grid; grid-template-columns: 1fr 1fr;"></div>
            </div>
            <div class="column">
                <h3>Advisor</h3> 
                <div id="advisor-list" style="display:grid; grid-template-columns: 1fr 1fr;"></div>
            </div>
        </div>
    </div>
</div>
<div id="donate" class="tab-content">
    <div class="container">
        <div style="display: flex; flex-wrap: wrap; gap: 40px; align-items: center; justify-content: center;">
            
            <div style="flex: 1; min-width: 250px; text-align: center;">
                <div style="background: white; padding: 15px; border: 1px solid #eee; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: inline-block;">
                    <img src="images/qr-code.png" alt="UPI QR Code" style="width: 200px; height: 200px; display: block;" onerror="this.src='https://via.placeholder.com/200?text=QR+Code+Missing'">
                    <p style="margin-top: 10px; color: var(--maroon); font-weight: bold; font-size: 0.9rem;">Scan to Pay via UPI</p>
                </div>
            </div>

            <div style="flex: 1; min-width: 300px;">
                <h2 style="color:var(--maroon); border-left: 5px solid var(--saffron); padding-left: 15px;">Support Our Seva</h2>
                
                <div style="background: #fffcf8; border: 1px solid var(--saffron); padding: 20px; border-radius: 8px;">
                    <table style="margin: 0; border: none; font-size: 1rem; width: 100%;">
                        <tr style="background: transparent;"><td style="border:none; padding: 5px; font-weight: bold; width: 130px;">Account Name:</td><td style="border:none; padding: 5px;">Dharma Paripalana Samithi</td></tr>
                        
                        <tr style="background: transparent;">
                            <td style="border:none; padding: 5px; font-weight: bold;">Account No:</td>
                            <td style="border:none; padding: 5px;">
                                <span id="accNum">500101013016821</span>
                                <button onclick="copyText('accNum')" style="margin-left:10px; font-size: 0.7rem; cursor: pointer; padding: 2px 5px;">Copy</button>
                            </td>
                        </tr>

                        <tr style="background: transparent;"><td style="border:none; padding: 5px; font-weight: bold;">Bank / IFSC:</td><td style="border:none; padding: 5px;">CUB / CIUB0000336</td></tr>
                        
                        <tr style="background: transparent;">
                            <td style="border:none; padding: 5px; font-weight: bold; color: var(--maroon);">UPI ID:</td>
                            <td style="border:none; padding: 5px; font-weight: bold; color: var(--maroon);">
                                <span id="upiId">EZE0098780@CUB</span>
                                <button onclick="copyText('upiId')" style="margin-left:10px; font-size: 0.7rem; cursor: pointer; padding: 2px 5px;">Copy</button>
                            </td>
                        </tr>
                    </table>
                </div>
                <p id="copyStatus" style="font-size: 0.8rem; color: green; margin-top: 5px; height: 1em;"></p>
                <p style="font-size: 0.85rem; color: #666; font-style: italic;">* Share screenshot to <strong>+91-98407 18054</strong> for receipt.</p>
            </div>
        </div>
    </div>
</div>
<div id="contact" class="tab-content">
    <div class="container">
        <div style="display: flex; flex-wrap: wrap; gap: 40px;">
            <div style="flex: 1; min-width: 300px;">
                <h2 style="color:var(--maroon); border-left: 5px solid var(--saffron); padding-left: 15px;">Get in Touch</h2>
                <p>For queries regarding events, pooja sponsorships, or volunteering, please reach out to us.</p>
                <p><strong>üìç Address:</strong> # 5137 Estancia Apartments, Tower 5, GST Road, Vallanchery, Guduvanchery - 603202</p>
                <p><strong>üìû Phone:</strong> +91-98407 18054</p>
                <p><strong>‚úâÔ∏è Email:</strong> dps.info@zohomail.in</p>
            </div>

   <div id="contact-form-container" style="min-height: 400px;flex: 1; min-width: 300px; background: #fdf2e9; padding: 25px; border-radius: 10px;">
    <form action="https://formspree.io/f/xdaagvbl" method="POST" id="contactForm">
    <label style="display:block; margin-bottom: 5px; font-weight: bold;">Your Name</label>
    <input type="text" name="name" maxlength="100" required style="width:100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px;">

    <label style="display:block; margin-bottom: 5px; font-weight: bold;">Email Address</label>
    <input type="email" name="_replyto" required style="width:100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px;">

    <label style="display:block; margin-bottom: 5px; font-weight: bold;">Are you an Estancia Resident?</label>
    <select name="is_resident" id="residentCheck" onchange="toggleFlatField()" style="width:100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px;">
        <option value="No">No</option>
        <option value="Yes">Yes</option>
    </select>

    <div id="flatField" style="display:none;">
        <label style="display:block; margin-bottom: 5px; font-weight: bold;">Flat Number (4 Digits)</label>
        <input type="text" id="flatNum" name="flat_number" placeholder="e.g., 5137" maxlength="4" 
               oninput="validateFlat()" 
               style="width:100%; padding: 10px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px;">
        <p id="flatError" style="color: red; font-size: 0.8rem; margin: 0 0 15px 0; display: none;">Invalid Flat Number format.</p>
    </div>

    <label style="display:block; margin-bottom: 5px; font-weight: bold;">Message</label>
    <textarea id="messageBox" name="message" rows="4" oninput="updateCount()" maxlength="1000" required style="width:100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
    
    <div style="text-align: right; margin-bottom: 15px;">
        <small id="charCounter" style="color: #666;">0 / 1000 characters</small>
    </div>

    <div style="margin-bottom: 15px; text-align: left;">
    <label style="display: flex; align-items: flex-start; cursor: pointer; font-size: 0.85rem; color: #555;">
        <input type="checkbox" name="privacy_policy" required style="margin-top: 4px; margin-right: 10px;">
        <span>
            I agree that the information provided (including my email and flat number) will only be used by 
            <strong>Dharma Paripalana Samithi</strong> to respond to this inquiry. 
            No data will be shared with third parties or used for unrelated purposes.
        </span>
    </label>
    </div>
    <div style="display:none;">
    <label>Leave this field blank</label>
    <input type="text" name="_honeypot" id="honeypot">
    </div>

    <button type="submit" id="submitBtn" style="background: var(--maroon); color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold;">
    <span class="spinner"></span>
    <span id="btnText">SEND MESSAGE</span>
    </button>

    </form>
    <div id="successMessage" style="display:none; text-align:center; padding: 40px; background: #fffcf8; border: 2px solid var(--saffron); border-radius: 10px;">
        <h3 style="color: var(--maroon);">üôè Om Namah Shivaya</h3>
        <p>Thank you for reaching out. Your message has been sent successfully. We will get back to you shortly.</p>
        <button onclick="resetForm()" style="background:none; border:none; color:var(--maroon); text-decoration:underline; cursor:pointer;">Send another message</button>
    </div>
   </div>
   </div>
  </div>
</div>
<footer>
    <p><strong>Dharma Paripalana Samithi Estancia</strong></p>
    <p># 5137 Estancia Apartments, GST Road, Vallanchery, Guduvanchery - 603202</p>
    <p>Email: dps.info@zohomail.in | Ph: +91-98407 18054</p>
</footer>

<script>

// --- APP STATE ---
const config = {
    events: 'data/events.csv',
    monthly_events: 'data/monthly_events.csv',
    trustees: 'data/trustees.csv',
    manifest: 'data/manifest.csv',
    highlightsDir: 'highlights/',
    logoPath: 'images/logo.png',
    qrPath: 'images/qr-code.png'
};

// Also update the logo error handler if you have one
const logoImg = document.getElementById('main-logo');
if (logoImg) logoImg.src = config.logoPath;

// --- TAB LOGIC ---
function switchTab(id) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.currentTarget.classList.add('active');
    window.scrollTo(0,0);
}

// --- DATA LOADING ---
async function loadCSV(file) {
    try {
        const res = await fetch(file);
        const text = await res.text();
        return text.split('\n').map(row => row.split(',')).filter(row => row.length > 1);
    } catch (e) { console.error("Error loading " + file, e); return []; }
}

// --- UPDATED INITIALIZE DATA ---
async function initApp() {
    // 1. Handle Logo Fallback
    const logo = document.getElementById('main-logo');
    if(logo) logo.onerror = () => { logo.style.display = 'none'; };

    // 2. Fetch all your CSV data first
    const events = await loadCSV(config.events);
    const trustees = await loadCSV(config.trustees);
    const photoData = await loadCSV(config.manifest);

    // 3. Existing logic for the full Tables (Monthly/Yearly)
    renderEventTables(events); // (Assuming you grouped your table logic here)
    renderSpecialEvents(events);

    // 2. Fetch the Monthly Calendar (The file you just created)
    const calendarRes = await fetch(config.monthly_events);
    const calendarText = await calendarRes.text();
        
    // Clean the data: remove empty lines and split into rows
    const calendarRows = calendarText.split('\n').filter(row => row.trim() !== '');

    // 3. CALL THE FUNCTIONS HERE
    // This updates the "Next 3" in the sidebar
    updateSidebar(calendarRows); 
        
        // This generates the 12-month grid in the main body
    renderMonthWiseView(calendarRows);
    //updateSidebar();

    // 4. Existing logic for the Trustees
    renderTrustees(trustees);

    // 5. Existing logic for the main Hero Slideshow
    startHeroSlideshow(photoData);
    
}

async function renderEventTables(events) {
    const yearlyTable = document.getElementById('yearly-list');
    events.slice(1).forEach(row => {
        if (row.length < 4) return; // Skip incomplete rows    
        const [date, detail, venue, type] = row;
        const htmlRow = `<tr><td>${date}</td><td>${detail}</td><td>${venue}</td></tr>`;
        yearlyTable.innerHTML += htmlRow;
    });
}

async function renderSpecialEvents(events) {
    const tableBody = document.getElementById('yearly-list');
    if (!tableBody) return;

    // 1. Filter for 'Yearly' and sort in DECREASING order
    const specialEvents = events.slice(1)
        .filter(row => row[3] && row[3].trim().toLowerCase() === 'yearly')
        .sort((a, b) => new Date(b[0]) - new Date(a[0])); // b - a for Descending

    tableBody.innerHTML = specialEvents.map(row => {
        const d = new Date(row[0].trim());
        
        // 2. Format to "21 January 2026"
        let formattedDate = "Invalid Date";
        if (!isNaN(d)) {
            formattedDate = d.toLocaleDateString('en-GB', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
        }

        return `
            <tr>
                <td style="white-space: nowrap;"><strong>${formattedDate}</strong></td>
                <td>${row[1]}</td>
                <td>${row[2]}</td>
                <td>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        ${row[4] ? `<button onclick="toggleMedia('${row[4].trim()}')" class="media-btn" style="background: var(--maroon); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">View Media</button>` : ''}
                        ${d > new Date() ? `<button onclick="switchTab('donate')" class="donate-btn" style="background: var(--saffron); color: var(--maroon); border: 1px solid var(--maroon); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold;">
                            Donate
                        </button>`:''}
                    </div>
                </td>
            </tr>`;
    }).join('');
}
async function renderTrustees(trustees) {
    const mgmtList = document.getElementById('mgmt-list');
    const trustList = document.getElementById('trustee-list');
    const advisorList = document.getElementById('advisor-list');
    trustees.slice(1).forEach(row => {
        if(row[2].trim().toLowerCase() === 'management') {
            mgmtList.innerHTML += `<div class="name-card"><strong>${row[0]}</strong><br><small style="color:#666">${row[1]}</small></div>`;
        } else if (row[2].trim().toLowerCase() === 'advisor') {
            advisorList.innerHTML += `<div class="name-card"><strong>${row[0]}</strong><br><small style="color:#666">${row[1]}</small></div>`;
        } else {
            trustList.innerHTML += `<div class="name-card"><strong>${row[0]}</strong></div>`;
        }
    });
}

// 4. Load Slideshow from Manifest
async function startHeroSlideshow(photoData) {
    const photos = photoData.slice(1);
    if(photos.length > 0) {
        let idx = 0;
        const box = document.getElementById('slideshow-box');
        const cap = document.getElementById('slide-caption');
            
        const nextSlide = () => {
            const [file, caption] = photos[idx];
            box.style.backgroundImage = `url(${config.highlightsDir}${file.trim()})`;
            cap.innerText = caption ? caption.trim() : "Dharma Paripalana Samithi";
            idx = (idx + 1) % photos.length;
        };
        nextSlide();
         setInterval(nextSlide, 5000);
    }
}

function copyText(elementId) {
    const text = document.getElementById(elementId).innerText;
    navigator.clipboard.writeText(text).then(() => {
        const status = document.getElementById('copyStatus');
        status.innerText = "Copied to clipboard!";
        setTimeout(() => { status.innerText = ""; }, 2000);
    });
}

function toggleFlatField() {
    const isResident = document.getElementById('residentCheck').value;
    const flatField = document.getElementById('flatField');
    const flatInput = document.getElementById('flatNum');
    
    if (isResident === 'Yes') {
        flatField.style.display = 'block';
        flatInput.setAttribute('required', 'true');
    } else {
        flatField.style.display = 'none';
        flatInput.removeAttribute('required');
        flatInput.value = ""; // Clear if hidden
    }
}

function validateFlat() {
    const val = document.getElementById('flatNum').value;
    const error = document.getElementById('flatError');
    const submitBtn = document.getElementById('submitBtn');
    
    // Rule Logic:
    // ^[1-5] : Tower 1-5
    // (0[1-9]|1[0-7]) : Floor 01-17
    // [1-8]$ : Flat 1-8
    const flatPattern = /^[1-5](0[1-9]|1[0-7])[1-8]$/;

    if (val.length === 4) {
        if (flatPattern.test(val)) {
            error.style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.style.opacity = "1";
        } else {
            error.innerText = "Tower(1-5), Floor(01-17), Flat(1-8). e.g. 5137";
            error.style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.style.opacity = "0.5";
        }
    } else {
        error.style.display = 'none';
    }
}

// Grab elements
const contactForm = document.getElementById("contactForm");
const successMessage = document.getElementById("successMessage");
const submitButton = document.getElementById("submitBtn");
const buttonText = document.getElementById("btnText");

async function handleSubmit(event) {
    event.preventDefault();
    
    // --- 1. RATE LIMITING (60-second Cooldown) ---
    const lastSub = localStorage.getItem('dps_last_submit');
    const now = Date.now();
    const cooldown = 60000; // 60 seconds in milliseconds

    if (lastSub && (now - lastSub < cooldown)) {
        const remaining = Math.ceil((cooldown - (now - lastSub)) / 1000);
        alert(`Please wait ${remaining} seconds before sending another message. This prevents spam.`);
        return;
    }

    // --- 2. ANTI-SPAM HONEYPOT ---
    if (document.getElementById("honeypot").value !== "") {
        return; 
    }

    // --- 3. INPUT SANITIZATION ---
    const formData = new FormData(event.target);
    const maliciousPattern = /[<>{}()[\]\\^]/; 
    let isClean = true;

    for (let [key, value] of formData.entries()) {
        if (key !== "message" && maliciousPattern.test(value)) { 
            alert("Special characters detected. Please use plain text.");
            isClean = false; break;
        }
    }
    if (!isClean) return;

    // --- 4. SUBMISSION PROCESS ---
    submitBtn.classList.add("loading");
    btnText.innerText = "SENDING...";

    try {
        const response = await fetch(event.target.action, {
            method: form.method,
            body: formData,
            headers: { 'Accept': 'application/json' }
        });

        if (response.ok) {
            // Success: Update LocalStorage with current timestamp
            localStorage.setItem('dps_last_submit', Date.now());
            
            form.style.display = "none";
            successMessage.style.display = "block";
            successMessage.classList.add("visible-element");
        } else {
            throw new Error();
        }
    } catch (err) {
        alert("Submission failed. Please try again later.");
    } finally {
        submitBtn.classList.remove("loading");
        btnText.innerText = "SEND MESSAGE";
    }
}

// Attach the listener
if (contactForm) {
    contactForm.addEventListener("submit", handleSubmit);
}

function resetForm() {
    // 1. Clear all text and selections in the form
    contactForm.reset();
    
    // 2. Hide the resident flat field (since the form reset sets 'Resident' back to 'No')
    if (typeof toggleFlatField === "function") {
        toggleFlatField();
    }

    // 3. Swap visibility back
    successMessage.classList.add("hidden-element");
    successMessage.classList.remove("visible-element");
    
    contactForm.classList.remove("hidden-element");
    contactForm.style.display = "block"; // Ensure it shows up

    // 4. Scroll back to the top of the form for the user
    contactForm.scrollIntoView({ behavior: 'smooth' });

    // 5. Reset character counter
    document.getElementById("charCounter").innerText = "0 / 1000 characters";
    document.getElementById("charCounter").style.color = "#666";
}

function updateCount() {
    const messageBox = document.getElementById("messageBox");
    const counter = document.getElementById("charCounter");
    const currentLength = messageBox.value.length;
    const maxLength = 1000;

    // Update the text
    counter.innerText = `${currentLength} / ${maxLength} characters`;

    // Visual feedback: Turn red if over 900 characters
    if (currentLength >= 900) {
        counter.style.color = "red";
        counter.style.fontWeight = "bold";
    } else {
        counter.style.color = "#666";
        counter.style.fontWeight = "normal";
    }
}

async function toggleMedia(mediaString) {
    const btn = event.target;
    const currentRow = btn.closest('tr');
    
    // Create a safe ID for the toggle row without breaking the actual data
    const safeId = btoa(mediaString).substring(0, 16).replace(/[/+=]/g, '');
    const existingMedia = document.getElementById(`media-${safeId}`);

    if (existingMedia) {
        existingMedia.remove();
        btn.innerText = "View Media";
        return;
    }

    const mediaRow = document.createElement('tr');
    mediaRow.id = `media-${safeId}`;
    
    // Use semicolon (;) as the separator now
    const parts = mediaString.split(';');
    let contentHtml = `<div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; padding: 20px; background: #fffcf8; border: 1px solid var(--saffron);">`;

    parts.forEach(part => {
        const trimmedPart = part.trim();
        if (trimmedPart.startsWith('YT:')) {
            // Extracts everything after YT: without losing underscores/dashes
            const ytId = trimmedPart.substring(3); 
            
            contentHtml += `
                <div style="flex: 1; min-width: 300px; text-align: center;">
                    <iframe width="100%" height="250" 
                        src="https://www.youtube-nocookie.com/embed/${ytId}?rel=0" 
                        frameborder="0" allowfullscreen 
                        style="border-radius:8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    </iframe>
                    <p style="margin-top: 8px;">
                        <a href="https://www.youtube.com/watch?v=${ytId}" target="_blank" style="font-size: 0.8rem; color: #ff0000; text-decoration: none; font-weight:bold;">
                            üì∫ Open in YouTube App
                        </a>
                    </p>
                </div>`;
        } 
        else if (trimmedPart.startsWith('GP:')) {
            const gpUrl = trimmedPart.substring(3);
            contentHtml += `
                <div style="flex: 1; min-width: 250px; display: flex; align-items: center; justify-content: center;">
                    <a href="${gpUrl}" target="_blank" class="media-link-btn gp-btn">
                        üñºÔ∏è View Google Photos Album
                    </a>
                </div>`;
        }
        else if (trimmedPart.startsWith('GD:')) {
            const gdId = trimmedPart.substring(3);
            contentHtml += `
                <div style="width: 100%; text-align: center;">
                    <a href="https://drive.google.com/drive/folders/${gdId}" target="_blank" class="media-link-btn gd-btn">
                        üìÅ Open Google Drive Folder
                    </a>
                </div>`;
        }
    });

    contentHtml += `</div>`;
    mediaRow.innerHTML = `<td colspan="4">${contentHtml}</td>`;
    
    currentRow.parentNode.insertBefore(mediaRow, currentRow.nextSibling);
    btn.innerText = "Close Media";
}
function renderMonthWiseView(rows) {
    const grid = document.getElementById('calendar-grid');
    if (!grid) return;

    const monthData = {};

    rows.forEach(row => {
        const cols = row.split(',');
        if (cols.length < 2) return;
        
        const dateObj = new Date(cols[0].trim());
        if (isNaN(dateObj)) return;

        const monthKey = dateObj.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
        
        if (!monthData[monthKey]) monthData[monthKey] = [];
        monthData[monthKey].push({
            day: dateObj.getDate(),
            weekday: dateObj.toLocaleDateString('en-GB', { weekday: 'short' }),
            name: cols[1].trim()
        });
    });

    grid.innerHTML = Object.entries(monthData).map(([monthName, dates]) => `
        <div class="month-card">
            <h4>${monthName}</h4>
            <ul>
                ${dates.map(d => {
                    // Logic to select the icon based on the event name
                    let icon = "";
                    if (d.name.toLowerCase().includes("sankatahara")) {
                        icon = '<img src="images/sankataharachathurthi.png" style="width:18px; vertical-align:middle;">'; // Or use an <img> tag for a custom Ganesha icon
                    } else if (d.name.toLowerCase().includes("pradosham")) {
                        icon = '<img src="images/pradosham.png" style="width:18px; vertical-align:middle;">'; // Or a Lingam icon/emoji
                    }

                    return `
                    <li style="display: flex; align-items: center; gap: 8px;">
                        <span style="color:var(--maroon); font-weight:bold; width: 25px;">${d.day}</span>
                        <span style="color:#888; font-size:0.75rem; width: 35px;">${d.weekday}</span>
                        <span style="font-size: 1.1rem; width: 20px; text-align: center;">${icon}</span>
                        <span>${d.name}</span>
                    </li>`;
                }).join('')}
            </ul>
        </div>
    `).join('');
}
async function updateSidebar(calendarRows) {
    const now = new Date();
    now.setHours(0,0,0,0);

    // 1. UPDATE SPECIAL EVENTS (from events.csv)
    try {
        const res = await fetch(config.events);
        const text = await res.text();
        const rows = text.split('\n').slice(1);
        
        const upcomingSpecials = rows
            .map(row => row.split(','))
            .filter(cols => cols.length >= 4 && cols[3].trim().toLowerCase() === 'yearly')
            .map(cols => ({ date: new Date(cols[0].trim()), name: cols[1].trim() }))
            .filter(item => !isNaN(item.date) && item.date >= now)
            .sort((a, b) => a.date - b.date) // Soonest first
            .slice(0, 2); // Show top 2 specials

        document.getElementById('upcoming-specials-list').innerHTML = upcomingSpecials.map(item => `
            <li style="margin-bottom: 12px;">
                <strong style="color:var(--maroon); font-size: 0.85rem;">
                    ${item.date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' })}
                </strong><br>
                <span style="font-size: 0.9rem;">${item.name}</span>
                <button onclick="switchTab('donate')" class="donate-btn" style="background: var(--saffron); color: var(--maroon); border: 1px solid var(--maroon); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold;">
                    Donate
                </button>
            </li>
        `).join('') || "<li>No upcoming festivals</li>";
    } catch (e) { console.error("Error loading special events", e); }

    // 2. UPDATE MONTHLY RITUALS (from monthly_calendar.csv)
    try {
        const rows = calendarRows;
        const nextMonthly = rows
            .map(row => row.split(','))
            .filter(cols => cols.length === 2)
            .map(cols => ({ date: new Date(cols[0].trim()), name: cols[1].trim() }))
            .filter(item => !isNaN(item.date) && item.date >= now)
            .sort((a, b) => a.date - b.date)
            .slice(0, 3); // Show top 3 monthly poojas

        document.getElementById('next-monthly-list').innerHTML = nextMonthly.map(item => `
            <li style="margin-bottom: 8px; font-size: 0.85rem;">
                <strong style="color:var(--maroon); font-size: 0.75rem;">
                    ${item.date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' })} : &nbsp;
                </strong>
            ${(item.name.toLowerCase().includes("sankatahara")) ? `<img src="images/sankataharachathurthi.png" style="width:18px; vertical-align:middle;">`
            : `<img src="images/pradosham.png" style="width:18px; vertical-align:middle;">`}${item.name}
            </li>
        `).join('') || "<li>Dates coming soon</li>";
    } catch (e) { console.error("Error loading monthly calendar", e); }
}

window.onload = initApp;
</script>

</body>
</html>